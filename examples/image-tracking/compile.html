<html>
  <head>
    <script src="./assets/dropzone/dropzone.min.js"></script>
    <link rel="stylesheet" href="./assets/dropzone/dropzone.min.css">
    
    <!-- Try multiple CDNs to avoid ORB blocking -->
    <script src="https://unpkg.com/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
    <script>
      // Fallback if unpkg fails
      if (!window.MINDAR) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.prod.js';
        script.onload = initApp;
        script.onerror = () => {
          // Last resort: try jsdelivr
          const script2 = document.createElement('script');
          script2.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js';
          script2.onload = initApp;
          document.head.appendChild(script2);
        };
        document.head.appendChild(script);
      } else {
        initApp();
      }

      function initApp() {
        const { Compiler } = window.MINDAR.IMAGE;
        const compiler = new Compiler();

        // Helper to download .mind files
        const download = (buffer) => {
          const a = document.createElement("a");
          a.download = "targets.mind";
          a.href = URL.createObjectURL(new Blob([buffer]));
          a.click();
          URL.revokeObjectURL(a.href);
        };

        const showData = (data) => {
          console.log("data", data);
          for (let i = 0; i < data.trackingImageList.length; i++) {
            const image = data.trackingImageList[i];
            const points = data.trackingData[i].points.map((p) => {
              return {x: Math.round(p.x), y: Math.round(p.y)};
            });
            showImage(image, points);
          }

          for (let i = 0; i < data.imageList.length; i++) {
            const image = data.imageList[i];
            const kpmPoints = [...data.matchingData[i].maximaPoints, ...data.matchingData[i].minimaPoints];
            const points2 = [];
            for (let j = 0; j < kpmPoints.length; j++) {
              points2.push({x: Math.round(kpmPoints[j].x), y: Math.round(kpmPoints[j].y)});
            }
            showImage(image, points2);
          }
        };

        const showImage = (targetImage, points) => {
          const container = document.getElementById("container");
          const canvas = document.createElement('canvas');
          container.appendChild(canvas);
          canvas.width  = targetImage.width;
          canvas.height = targetImage.height;
          canvas.style.width = canvas.width;
          const ctx = canvas.getContext('2d');
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = new Uint32Array(imageData.data.buffer);

          const alpha = (0xff << 24);
          for (let c = 0; c < targetImage.width; c++) {
            for (let r = 0; r < targetImage.height; r++) {
              const pix = targetImage.data[r * targetImage.width + c];
              data[r * canvas.width + c] = alpha | (pix << 16) | (pix << 8) | pix;
            }
          }

          var pix = (0xff << 24) | (0x00 << 16) | (0xff << 8) | 0x00; // green
          for (let i=0; i < points.length; ++i) {
            const x = points[i].x;
            const y = points[i].y;
            const offset = (x + y * canvas.width);
            data[offset] = pix;
            //for (var size = 1; size <= 3; size++) {
            for (var size = 1; size <= 6; size++) {
              data[offset-size] = pix;
              data[offset+size] = pix;
              data[offset-size*canvas.width] = pix;
              data[offset+size*canvas.width] = pix;
            }
          }
          ctx.putImageData(imageData, 0, 0);
        };

        // Visualization and utility functions
        const loadImage = (file) => new Promise((resolve, reject) => {
          const url = URL.createObjectURL(file);
          const img = new Image();
          img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
          img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
          img.src = url;
        });

        const compileFiles = async (files) => {
          const images = await Promise.all(files.map(loadImage));
          const dataList = await compiler.compileImageTargets(images, p =>
            document.getElementById("progress").textContent = `progress: ${(p*100).toFixed(2)}%`
          );
          dataList.forEach(showData);

          const exported = await compiler.exportData();
          document.getElementById("downloadButton").onclick = () => download(exported);
        };

        const loadMindFile = async (file) => {
          const buffer = await file.arrayBuffer();
          const dataList = compiler.importData(buffer);
          dataList.forEach(showData);
        };

        document.addEventListener("DOMContentLoaded", () => {
          Dropzone.autoDiscover = false;
          const dz = new Dropzone("#dropzone", {url: "#", autoProcessQueue: false, addRemoveLinks: true});
          document.getElementById("startButton").onclick = () => {
            if (!dz.files.length) return;
            const ext = dz.files[0].name.split(".").pop().toLowerCase();
            ext === "mind" ? loadMindFile(dz.files[0]) : compileFiles(dz.files);
          };
        });
      }
    </script>

    <style>
      #container {
        display: flex;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div>
      <p>Usage:</p>
      <ol>
        <li>drop target images (e.g. .png) into the drop zone. (can drop multiple)</li>
        <li>click "Start". It could take a while (especially for large image)</li>
        <li>When done, some debug images will shown, and you can visualize the feature points.</li>
        <li>click "download" to get a targets.mind file, which is used in the AR webpage</li>
      </ol>
    </div>
    <button id="startButton">Start</button>
    <button id="downloadButton">Download</button>
    <span id="progress"></span>
    <div id="dropzone" class="dropzone"></div>

    <!-- Change /upload-target to your upload address -->
    <div id="container">
    </div>
  </body>
</html>

