<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindAR - Image Targets Compiler</title>
    
    <!-- Dropzone for file uploads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.2/min/dropzone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.2/dropzone.min.css">
    
    <!-- MindAR Compiler -->
    <script type="module">
        import { Compiler } from "../../src/image-target/compiler.js";

        // Disable Dropzone auto-discovery BEFORE any Dropzone code runs
        if (typeof Dropzone !== 'undefined') {
            Dropzone.autoDiscover = false;
        }

        // Initialize the MindAR compiler
        const compiler = new Compiler();
        let compiledData = null;

        // Download function for compiled .mind files
        const downloadMindFile = (buffer, filename = 'targets.mind') => {
            const blob = new Blob([buffer]);
            const aLink = window.document.createElement('a');
            aLink.download = filename;
            aLink.href = window.URL.createObjectURL(blob);
            aLink.click();
            window.URL.revokeObjectURL(aLink.href);
        };

        // Display compiled data with feature points visualization
        const showCompiledData = (data) => {
            console.log("Compiled data:", data);
            
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            
            // Show tracking images with feature points
            if (data.trackingImageList && data.trackingData) {
                for (let i = 0; i < data.trackingImageList.length; i++) {
                    const image = data.trackingImageList[i];
                    const points = data.trackingData[i].points.map((p) => {
                        return {x: Math.round(p.x), y: Math.round(p.y)};
                    });
                    showImageWithPoints(image, points, `Tracking Image ${i + 1}`);
                }
            }

            // Show matching images with keypoint maxima/minima
            if (data.imageList && data.matchingData) {
                for (let i = 0; i < data.imageList.length; i++) {
                    const image = data.imageList[i];
                    const kpmPoints = [
                        ...data.matchingData[i].maximaPoints, 
                        ...data.matchingData[i].minimaPoints
                    ];
                    const points = kpmPoints.map(p => ({
                        x: Math.round(p.x), 
                        y: Math.round(p.y)
                    }));
                    showImageWithPoints(image, points, `Matching Image ${i + 1}`);
                }
            }
        };

        // Render image with feature points overlay
        const showImageWithPoints = (targetImage, points, title) => {
            const resultsContainer = document.getElementById('results');
            
            // Create image container
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-result';
            imageContainer.innerHTML = `<h3>${title}</h3>`;
            
            // Create canvas for visualization
            const canvas = document.createElement('canvas');
            canvas.width = targetImage.width;
            canvas.height = targetImage.height;
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = new Uint32Array(imageData.data.buffer);

            // Convert grayscale to RGB
            const alpha = (0xff << 24);
            for (let c = 0; c < targetImage.width; c++) {
                for (let r = 0; r < targetImage.height; r++) {
                    const pix = targetImage.data[r * targetImage.width + c];
                    data[r * canvas.width + c] = alpha | (pix << 16) | (pix << 8) | pix;
                }
            }

            // Draw feature points in green
            const pointColor = (0xff << 24) | (0x00 << 16) | (0xff << 8) | 0x00;
            for (let i = 0; i < points.length; ++i) {
                const x = points[i].x;
                const y = points[i].y;
                const offset = (x + y * canvas.width);
                
                // Draw point with size
                for (let size = 0; size <= 3; size++) {
                    if (x - size >= 0 && x + size < canvas.width && 
                        y - size >= 0 && y + size < canvas.height) {
                        data[offset] = pointColor;
                        if (size > 0) {
                            data[offset - size] = pointColor;
                            data[offset + size] = pointColor;
                            data[offset - size * canvas.width] = pointColor;
                            data[offset + size * canvas.width] = pointColor;
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            imageContainer.appendChild(canvas);
            
            // Add image info
            const info = document.createElement('p');
            info.textContent = `Size: ${targetImage.width} Ã— ${targetImage.height} | Feature Points: ${points.length}`;
            imageContainer.appendChild(info);
            
            resultsContainer.appendChild(imageContainer);
        };

        // Load image from file
        const loadImage = async (file) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        };

        // Compile multiple images into MindAR targets
        const compileImages = async (files) => {
            try {
                // Show progress
                document.getElementById('progress').innerHTML = 'Loading images...';
                document.getElementById('startButton').disabled = true;
                
                // Load all images
                const images = [];
                for (let i = 0; i < files.length; i++) {
                    images.push(await loadImage(files[i]));
                }
                
                document.getElementById('progress').innerHTML = 'Compiling targets...';
                
                // Compile with progress callback
                const startTime = new Date().getTime();
                const dataList = await compiler.compileImageTargets(images, (progress) => {
                    document.getElementById('progress').innerHTML = `Compiling: ${progress.toFixed(2)}%`;
                });
                
                const compileTime = new Date().getTime() - startTime;
                console.log(`Compilation completed in ${compileTime}ms`);
                
                // Display results
                for (let i = 0; i < dataList.length; i++) {
                    showCompiledData(dataList[i]);
                }
                
                // Enable download
                compiledData = await compiler.exportData();
                document.getElementById('downloadButton').disabled = false;
                document.getElementById('progress').innerHTML = `Compilation completed! Generated ${dataList.length} targets.`;
                
            } catch (error) {
                console.error('Compilation error:', error);
                document.getElementById('progress').innerHTML = `Error: ${error.message}`;
            } finally {
                document.getElementById('startButton').disabled = false;
            }
        };

        // Load and display existing .mind file
        const loadMindFile = async (file) => {
            try {
                document.getElementById('progress').innerHTML = 'Loading .mind file...';
                
                const reader = new FileReader();
                reader.onload = function() {
                    try {
                        const dataList = compiler.importData(this.result);
                        document.getElementById('progress').innerHTML = `Loaded ${dataList.length} targets from .mind file`;
                        
                        for (let i = 0; i < dataList.length; i++) {
                            showCompiledData(dataList[i]);
                        }
                        
                        compiledData = this.result;
                        document.getElementById('downloadButton').disabled = false;
                        
                    } catch (error) {
                        document.getElementById('progress').innerHTML = `Error loading .mind file: ${error.message}`;
                    }
                };
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                document.getElementById('progress').innerHTML = `Error: ${error.message}`;
            }
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure Dropzone auto-discovery is disabled
            if (typeof Dropzone !== 'undefined') {
                Dropzone.autoDiscover = false;
            }
            
            // Initialize Dropzone with proper configuration
            const myDropzone = new Dropzone("#dropzone", { 
                url: "#", 
                autoProcessQueue: false, 
                addRemoveLinks: true,
                acceptedFiles: "image/*,.mind",
                maxFiles: 10,
                createImageThumbnails: false,
                maxThumbnailFilesize: 0
            });

            // Handle file additions
            myDropzone.on("addedfile", function(file) {
                console.log("Added file:", file.name);
            });

            // Start button handler
            document.getElementById("startButton").addEventListener("click", function() {
                const files = myDropzone.files;
                if (files.length === 0) {
                    alert("Please add some files first!");
                    return;
                }
                
                const ext = files[0].name.split('.').pop().toLowerCase();
                if (ext === 'mind') {
                    loadMindFile(files[0]); 
                } else {
                    compileImages(files);
                }
            });

            // Download button handler
            document.getElementById("downloadButton").addEventListener("click", function() {
                if (compiledData) {
                    const filename = prompt("Enter filename (without extension):", "targets");
                    downloadMindFile(compiledData, filename ? `${filename}.mind` : 'targets.mind');
                }
            });
        });
    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .usage {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .usage h2 {
            color: #333;
            margin-top: 0;
        }

        .usage ol {
            line-height: 1.6;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #startButton {
            background-color: #007bff;
            color: white;
        }

        #startButton:hover:not(:disabled) {
            background-color: #0056b3;
        }

        #downloadButton {
            background-color: #28a745;
            color: white;
        }

        #downloadButton:hover:not(:disabled) {
            background-color: #1e7e34;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #progress {
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-weight: 500;
            color: #495057;
        }

        .dropzone {
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: white;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .dropzone:hover {
            border-color: #0056b3;
            background-color: #f8f9fa;
        }

        .dropzone .dz-message {
            color: #6c757d;
            font-size: 18px;
        }

        #results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-result {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .image-result h3 {
            margin-top: 0;
            color: #333;
            font-size: 16px;
        }

        .image-result canvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .image-result p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            button {
                width: 100%;
            }
            
            #results {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MindAR Image Targets Compiler</h1>
        <p>Compile your images into MindAR-compatible target files</p>
    </div>

    <div class="usage">
        <h2>How to Use</h2>
        <ol>
            <li><strong>Upload Images:</strong> Drag and drop target images (PNG, JPG, etc.) into the drop zone below. You can upload multiple images at once.</li>
            <li><strong>Compile:</strong> Click "Start" to begin compilation. This process may take several minutes for large images.</li>
            <li><strong>Review:</strong> View the compiled results with feature points highlighted in green.</li>
            <li><strong>Download:</strong> Click "Download" to get your <code>.mind</code> file for use in AR applications.</li>
        </ol>
        <p><strong>Note:</strong> You can also load existing <code>.mind</code> files to view their contents.</p>
    </div>

    <div class="controls">
        <button id="startButton">Start Compilation</button>
        <button id="downloadButton" disabled>Download .mind File</button>
        <span id="progress">Ready to compile</span>
    </div>

    <div id="dropzone" class="dropzone">
        <div class="dz-message">
            <strong>Drop images here</strong><br>
            <span>or click to select files</span>
        </div>
    </div>

    <div id="results"></div>
</body>
</html>

